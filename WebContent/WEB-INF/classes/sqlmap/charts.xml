<!DOCTYPE sqlMap
PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="charts">
	<select id="getPastAttendance" resultClass="com.hris.portal.model.ChartBean">
		SELECT 	tbla.department AS departmentName,
				jml_hadir AS totalPresence,
				jml_emp_dept AS totalEmployee, 
				(jml_hadir/jml_emp_dept) AS averageAttendance
		FROM(
		SELECT department, SUM(jmlHadir) AS jml_hadir
		FROM(
		    SELECT emp.employee_id, department,jmlHadir
		    FROM ms_employee emp JOIN
		        (SELECT employee_id, COUNT(attendance_id) AS jmlHadir
		        FROM tr_attendance
		        WHERE TO_CHAR(check_in, 'mm/yyyy') BETWEEN TO_CHAR(ADD_MONTHS(SYSDATE,-3),'mm/yyyy')  AND TO_CHAR(ADD_MONTHS(SYSDATE,-1),'mm/yyyy') 
		        GROUP BY employee_id)   att
		    ON emp.employee_id=att.employee_id
		    JOIN ms_department dept ON emp.department_id=dept.department_id
		    ORDER BY emp.employee_id
		) 
		GROUP BY department
		)tbla
		JOIN 
		(
		   SELECT department,COUNT(*) jml_emp_dept
		   FROM ms_employee emp
		   JOIN ms_department dept ON emp.department_id=dept.department_id
		   GROUP BY department
		) dept_emp_count on tbla.department = dept_emp_count.department
	</select>
</sqlMap>